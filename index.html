#!/bin/bash
# Decred Node Installation Script
# Installs and configures a Decred node as a systemd service.
#
# Usage:
#   curl -L https://node.dcr.pw | sudo bash

# Exit immediately if a command exits with a non-zero status.
set -euo pipefail

# --- Configuration ---
# Dedicated system user for running the Decred daemon.
DCR_USER="decred"
# Data directory for blockchain and configuration files.
DCR_HOME="/var/lib/decred"
# Installation log file location.
LOG_FILE="/var/log/decred_setup.log"
# Temporary directory for downloads (set during execution).
TMP_DIR=""

# --- Functions ---
# Log messages to both stdout and log file with timestamp.
log_message() {
    echo "$(date '+%Y-%m-%d %H:%M:%S') - $1" | tee -a "$LOG_FILE"
}

# Clean up temporary directory on script exit.
cleanup() {
    if [ -n "$TMP_DIR" ] && [ -d "$TMP_DIR" ]; then
        log_message "Cleaning up temporary directory..."
        rm -rf "$TMP_DIR"
    fi
}

# Register cleanup function to run on exit.
trap cleanup EXIT

# --- Script Start ---
# 1. Check for Root Permissions
if [ "$(id -u)" -ne "0" ]; then
    echo "This script must be run as root. Please use sudo."
    exit 1
fi

# Initialize log file with proper permissions.
touch "$LOG_FILE"
chmod 644 "$LOG_FILE"

log_message "Starting Decred node setup..."

# 2. Verify Required Dependencies
for cmd in curl jq; do
    if ! command -v "$cmd" &> /dev/null; then
        log_message "Error: '$cmd' is not installed. Please install it first."
        log_message "On Debian/Ubuntu, run: apt-get update && apt-get install -y $cmd"
        exit 1
    fi
done


# 3. Detect System Architecture
arch=$(uname -m)
case "$arch" in
    'x86_64') a='amd64' ;;
    'aarch64') a='arm64' ;;
    *) log_message "Error: Unsupported architecture: $arch"; exit 1 ;;
esac
log_message "Detected architecture: $arch ($a)"

# 4. Fetch Latest Decred Version
log_message "Fetching the latest Decred version..."
v=$(curl -sSf "https://api.github.com/repos/decred/decred-binaries/releases/latest" | jq -r .tag_name)
if [ -z "$v" ] || [ "$v" = "null" ]; then
    log_message "Error: Could not fetch the latest version tag from GitHub."
    exit 1
fi
log_message "Latest version is $v"

# 5. Download and Verify Decred Binaries
b="decred-linux-${a}-${v}.tar.gz"
download_url="https://github.com/decred/decred-binaries/releases/download/${v}/${b}"
manifest_url="https://github.com/decred/decred-binaries/releases/download/${v}/manifest-${v}.txt"

# Create temporary directory for downloads.
TMP_DIR=$(mktemp -d)
log_message "Using temporary directory: $TMP_DIR"

log_message "Downloading $b..."
if ! curl -sSfL -o "${TMP_DIR}/${b}" "$download_url"; then
    log_message "Error: Failed to download binaries from $download_url"
    exit 1
fi

log_message "Downloading manifest for checksum verification..."
if curl -sSfL -o "${TMP_DIR}/manifest.txt" "$manifest_url"; then
    log_message "Verifying checksum..."
    cd "$TMP_DIR"
    if grep "$b" manifest.txt | sha256sum -c --status; then
        log_message "Checksum verification passed."
    else
        log_message "Warning: Checksum verification failed or not found in manifest."
    fi
    cd - > /dev/null
else
    log_message "Warning: Could not download manifest file. Skipping checksum verification."
fi

log_message "Extracting binaries to /usr/local/bin/..."
# Extract archive to temporary directory.
tar -xzf "${TMP_DIR}/${b}" -C "$TMP_DIR"

# Copy Decred binaries to system path.
find "$TMP_DIR" -name "dcrd" -type f -executable -exec cp {} /usr/local/bin/ \;
find "$TMP_DIR" -name "dcrctl" -type f -executable -exec cp {} /usr/local/bin/ \;
find "$TMP_DIR" -name "dcrwallet" -type f -executable -exec cp {} /usr/local/bin/ \;

# Verify dcrd binary was successfully installed.
if [ ! -x "/usr/local/bin/dcrd" ]; then
    log_message "Error: dcrd binary not found after extraction."
    exit 1
fi

chmod +x /usr/local/bin/dcrd /usr/local/bin/dcrctl /usr/local/bin/dcrwallet 2>/dev/null || true
log_message "Binaries installed successfully."

# 6. Configure System User and Data Directory
if ! id -u "$DCR_USER" >/dev/null 2>&1; then
    log_message "Creating system user '$DCR_USER'..."
    useradd -r -m -d "$DCR_HOME" -s /usr/sbin/nologin "$DCR_USER"
else
    log_message "User '$DCR_USER' already exists."
fi
# Create data directory structure with secure permissions.
mkdir -p "$DCR_HOME"
mkdir -p "$DCR_HOME/logs/mainnet"
chown -R "${DCR_USER}:${DCR_USER}" "$DCR_HOME"
chmod 700 "$DCR_HOME"
log_message "Data directory configured at $DCR_HOME"

# 7. Stop Existing Service
if systemctl is-active --quiet dcrd.service; then
    log_message "Stopping existing dcrd service..."
    systemctl stop dcrd.service
fi

# 8. Create Systemd Service File
log_message "Creating dcrd systemd service..."
cat > /etc/systemd/system/dcrd.service <<EOF
[Unit]
Description=Decred daemon
After=network.target

[Service]
Type=simple
# Run as dedicated non-root user for security.
User=$DCR_USER
Group=$DCR_USER
# Specify data directory location.
ExecStart=/usr/local/bin/dcrd --appdata=$DCR_HOME
Restart=on-failure
RestartSec=10
LimitNOFILE=65536

[Install]
WantedBy=multi-user.target
EOF

# 9. Enable and Start Decred Service
log_message "Enabling and starting dcrd service..."
systemctl daemon-reload
systemctl enable dcrd.service
systemctl start dcrd.service

# Verify service started successfully.
sleep 2
if systemctl is-active --quiet dcrd.service; then
    log_message "dcrd service started successfully."
else
    log_message "Warning: dcrd service may not have started correctly."
    log_message "Check status with: systemctl status dcrd"
fi

# 10. Create Status Monitoring Script
log_message "Creating status script at /usr/local/bin/decred.sh..."

# Generate helper script with embedded version and path information.
cat > /usr/local/bin/decred.sh <<EOF
#!/bin/bash

# Display Decred ASCII art logo.
cat <<'ART'

    ██████╗ ███████╗ ██████╗██████╗ ███████╗██████╗ 
    ██╔══██╗██╔════╝██╔════╝██╔══██╗██╔════╝██╔══██╗
    ██║  ██║█████╗  ██║     ██████╔╝█████╗  ██║  ██║
    ██║  ██║██╔══╝  ██║     ██╔══██╗██╔══╝  ██║  ██║
    ██████╔╝███████╗╚██████╗██║  ██║███████╗██████╔╝
    ╚═════╝ ╚══════╝ ╚═════╝╚═╝  ╚═╝╚══════╝╚═════╝ 
ART

# Display version information.
printf " d c r d   n o d e   ${v}\n"
echo   "============================="
echo   ""

# Tail the dcrd log file in real-time.
tail -f "${DCR_HOME}/logs/mainnet/dcrd.log"
EOF

# Make status script executable.
chmod +x /usr/local/bin/decred.sh

# 11. Display Installation Summary
log_message "Installation complete."
printf "\n✅ Installation complete! Your Decred node is running.\n"
printf "   - To check the status: systemctl status dcrd\n"
printf "   - To monitor the log in real-time: decred.sh\n"
printf "   - To view logs: journalctl -u dcrd -f\n"
printf "   - Binaries installed: dcrd, dcrctl, dcrwallet\n\n"
